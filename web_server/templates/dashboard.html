
<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Dashboard - V Cube</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/static/styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  </head>
  <body>
    <nav class="navbar">
      <div class="container">
        <span class="navbar-brand" style="color: var(--primary-color); font-weight: 600; font-size: 1.5rem;">
          V Cube Software Solutions
        </span>
        <button class="button" id="logoutBtn" style="background-color: var(--accent-color);">Logout</button>
      </div>
    </nav>

    <div class="container py-5">
      <div id="welcome" class="mb-4"></div>
      <div class="row">
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-body">
              <h4 style="color: var(--secondary-color);">Your Course</h4>
              <div id="courseFolder" class="p-4 border rounded bg-light mt-3"></div>
            </div>
          </div>
        </div>
        <div class="col-md-6 mb-4">
          <div class="card">
            <div class="card-body">
              <h4 style="color: var(--secondary-color);">Security Settings</h4>
              <form id="form-change" class="mt-3">
                <div class="mb-3">
                  <label class="form-label">Current Password</label>
                  <input type="password" id="oldpw" class="form-control" required>
                </div>
                <div class="mb-3">
                  <label class="form-label">New Password</label>
                  <input type="password" id="newpw" class="form-control" required>
                </div>
                <button class="button" style="background-color: var(--secondary-color);">Update Password</button>
              </form>
              <div id="msg" class="mt-3"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API = localStorage.getItem('api_url') || null;
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');

      if(!token){ window.location = '/'; }

      document.getElementById('welcome').innerHTML = `
        <div class="mb-4">
          <h2 style="color: var(--primary-color); font-weight: 600;">Welcome, ${user.name || ''}!</h2>
          <p class="text-muted">Learning and Growing with V Cube Software Solutions</p>
        </div>
      `;
      document.getElementById('courseFolder').innerHTML = `
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h5 style="color: var(--text-color);">${user.course || ''}</h5>
            <p class="text-muted mb-0">Current Enrollment</p>
          </div>
          <button class="button" id="changeCourse" style="background-color: var(--primary-color);">Change Course</button>
        </div>
      `;

      document.getElementById('changeCourse').addEventListener('click', ()=>{
        const newCourse = prompt('Enter new course name', user.course || '');
        if(!newCourse) return;
        // For simplicity, change course only in localStorage and call API to update password is out of scope.
        user.course = newCourse;
        localStorage.setItem('user', JSON.stringify(user));
        document.getElementById('courseFolder').innerHTML = `<strong>${user.course}</strong>`;
        alert('Course changed locally. To persist this change, server-side endpoint would be required.');
      });

      document.getElementById('logoutBtn').addEventListener('click', ()=>{
        localStorage.removeItem('token'); localStorage.removeItem('user');
        window.location = '/';
      });

      document.getElementById('form-change').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const oldpw = document.getElementById('oldpw').value;
        const newpw = document.getElementById('newpw').value;
        try{
          const res = await fetch((localStorage.getItem('api_url') || (new URL(location).origin.replace(':5000',':5001'))) + '/api/change_password', {
            method: 'POST',
            headers: {'Content-Type':'application/json','Authorization':'Bearer ' + token},
            body: JSON.stringify({old_password: oldpw, new_password: newpw})
          });
          const j = await res.json();
          if(res.ok){ document.getElementById('msg').innerHTML = `<div class="alert alert-success">${j.message}</div>`; }
          else{ document.getElementById('msg').innerHTML = `<div class="alert alert-danger">${j.message}</div>`; }
        }catch(err){
          document.getElementById('msg').innerHTML = `<div class="alert alert-danger">Error: ${err}</div>`;
        }
      });
    </script>
  </body>
</html>
